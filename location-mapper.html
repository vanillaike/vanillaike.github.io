<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4285F4">
    <title>Location Mapper</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background-color: #4285F4;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #map {
            height: 100%;
            width: 100%;
            flex-grow: 1;
        }
        
        #controls {
            padding: 1rem;
            background-color: #f1f1f1;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        button, input {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        button {
            background-color: #4285F4;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #3367D6;
        }
        
        #pin-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        #pin-form input, #pin-form textarea {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        #offline-message {
            display: none;
            background-color: #FFC107;
            color: black;
            padding: 0.5rem;
            text-align: center;
        }
        
        .install-prompt {
            display: none;
            padding: 0.5rem;
            background-color: #e9f5ff;
            border: 1px solid #4285F4;
            border-radius: 4px;
            margin: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Location Mapper</h1>
        <button id="install-btn" style="display: none;">Install App</button>
    </header>
    
    <div id="offline-message">You're currently offline. Some features may be limited.</div>
    
    <div id="install-prompt" class="install-prompt">
        Add this app to your home screen for a better experience.
        <button id="close-prompt">Dismiss</button>
    </div>
    
    <div id="controls">
        <button id="current-location">Get My Location</button>
        <button id="add-pin">Add New Pin</button>
        <button id="clear-pins">Clear All Pins</button>
    </div>
    
    <div id="map"></div>
    
    <div id="pin-form">
        <h3>Add New Pin</h3>
        <input type="text" id="pin-title" placeholder="Title" maxlength="50">
        <textarea id="pin-description" placeholder="Description" rows="3" maxlength="200"></textarea>
        <div>
            <button id="save-pin">Save</button>
            <button id="cancel-pin">Cancel</button>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let markers = [];
        let currentPosition = null;
        let tempMarker = null;
        let deferredPrompt;

        // Initialize the application
        function initApp() {
            // Check if the app is already loaded from cache
            document.addEventListener('DOMContentLoaded', checkNetworkStatus);
            window.addEventListener('online', checkNetworkStatus);
            window.addEventListener('offline', checkNetworkStatus);
            
            // Set up the install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBtn = document.getElementById('install-btn');
                installBtn.style.display = 'block';
                
                // Show install prompt after 30 seconds if the user hasn't interacted with it
                setTimeout(() => {
                    if (deferredPrompt && !localStorage.getItem('installPromptDismissed')) {
                        document.getElementById('install-prompt').style.display = 'block';
                    }
                }, 30000);
            });
            
            document.getElementById('install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    document.getElementById('install-btn').style.display = 'none';
                }
            });
            
            document.getElementById('close-prompt').addEventListener('click', () => {
                document.getElementById('install-prompt').style.display = 'none';
                localStorage.setItem('installPromptDismissed', 'true');
            });

            // Set up event listeners
            document.getElementById('current-location').addEventListener('click', goToCurrentLocation);
            document.getElementById('add-pin').addEventListener('click', startAddPin);
            document.getElementById('clear-pins').addEventListener('click', clearAllPins);
            document.getElementById('save-pin').addEventListener('click', savePinData);
            document.getElementById('cancel-pin').addEventListener('click', cancelAddPin);
            
            // Load saved pins from local storage
            loadSavedPins();
        }

        // Check network status and display offline message if needed
        function checkNetworkStatus() {
            const offlineMessage = document.getElementById('offline-message');
            if (navigator.onLine) {
                offlineMessage.style.display = 'none';
            } else {
                offlineMessage.style.display = 'block';
            }
        }

        // Initialize Google Maps
        function initMap() {
            const defaultLocation = { lat: 37.7749, lng: -122.4194 }; // San Francisco as default
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 12,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ],
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: true,
                zoomControl: true
            });
            
            // Add click listener to the map for adding pins
            map.addListener('click', function(event) {
                if (document.getElementById('pin-form').style.display === 'block') {
                    // If we're in pin adding mode, place a temporary marker
                    if (tempMarker) tempMarker.setMap(null);
                    tempMarker = new google.maps.Marker({
                        position: event.latLng,
                        map: map,
                        draggable: true,
                        animation: google.maps.Animation.DROP
                    });
                }
            });
            
            // Try to get the user's location immediately
            goToCurrentLocation();
            
            // Now that the map is initialized, complete app setup
            initApp();
        }

        // Go to the user's current location
        function goToCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(currentPosition);
                        map.setZoom(15);
                        
                        // Create a marker for current location if it doesn't exist
                        const existingMarker = markers.find(marker => marker.title === "My Location");
                        if (existingMarker) {
                            existingMarker.setPosition(currentPosition);
                        } else {
                            const marker = new google.maps.Marker({
                                position: currentPosition,
                                map: map,
                                title: "My Location",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 10,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "#FFFFFF",
                                    strokeWeight: 2
                                }
                            });
                            
                            markers.push(marker);
                        }
                    },
                    (error) => {
                        console.error("Error getting location:", error);
                        alert("Unable to retrieve your location. Please check your device settings.");
                    }
                );
            } else {
                alert("Geolocation is not supported by your browser.");
            }
        }

        // Start the process of adding a pin
        function startAddPin() {
            document.getElementById('pin-form').style.display = 'block';
            document.getElementById('pin-title').value = '';
            document.getElementById('pin-description').value = '';
            
            // Alert the user to click on the map
            alert("Click on the map to place your pin!");
        }

        // Save pin data when the save button is clicked
        function savePinData() {
            const title = document.getElementById('pin-title').value.trim();
            const description = document.getElementById('pin-description').value.trim();
            
            if (!title) {
                alert("Please enter a title for your pin.");
                return;
            }
            
            if (!tempMarker) {
                alert("Please click on the map to place your pin.");
                return;
            }
            
            // Create an actual marker
            const marker = new google.maps.Marker({
                position: tempMarker.getPosition(),
                map: map,
                title: title,
                animation: google.maps.Animation.DROP
            });
            
            // Create an info window with pin information
            const infoWindow = new google.maps.InfoWindow({
                content: `<div><h3>${title}</h3><p>${description}</p></div>`
            });
            
            // Add event listener to open info window on click
            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
            
            // Add to markers array
            markers.push(marker);
            
            // Save to local storage
            savePinsToStorage();
            
            // Clean up
            tempMarker.setMap(null);
            tempMarker = null;
            document.getElementById('pin-form').style.display = 'none';
        }

        // Cancel adding a pin
        function cancelAddPin() {
            if (tempMarker) {
                tempMarker.setMap(null);
                tempMarker = null;
            }
            document.getElementById('pin-form').style.display = 'none';
        }

        // Clear all pins
        function clearAllPins() {
            if (confirm("Are you sure you want to remove all pins?")) {
                // Remove all markers from the map
                for (let marker of markers) {
                    if (marker.title !== "My Location") {
                        marker.setMap(null);
                    }
                }
                
                // Filter out the removed markers, keeping only "My Location"
                markers = markers.filter(marker => marker.title === "My Location");
                
                // Update localStorage
                savePinsToStorage();
            }
        }

        // Save pins to localStorage
        function savePinsToStorage() {
            const pinsToSave = markers
                .filter(marker => marker.title !== "My Location")
                .map(marker => {
                    return {
                        title: marker.title,
                        description: marker.get('description') || '',
                        position: {
                            lat: marker.getPosition().lat(),
                            lng: marker.getPosition().lng()
                        }
                    };
                });
                
            localStorage.setItem('savedPins', JSON.stringify(pinsToSave));
        }

        // Load pins from localStorage
        function loadSavedPins() {
            const savedPins = JSON.parse(localStorage.getItem('savedPins')) || [];
            
            savedPins.forEach(pin => {
                const marker = new google.maps.Marker({
                    position: pin.position,
                    map: map,
                    title: pin.title,
                    animation: google.maps.Animation.DROP
                });
                
                // Store the description with the marker
                marker.set('description', pin.description);
                
                // Create an info window with pin information
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div><h3>${pin.title}</h3><p>${pin.description}</p></div>`
                });
                
                // Add event listener to open info window on click
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                markers.push(marker);
            });
        }
    </script>
    
    <!-- Load Google Maps API -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>
    
    <!-- Register service worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>